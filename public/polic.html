<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>
    </title>
    <link href="/bootstrap.min.css"
    rel="stylesheet">
    <script src="/angular.min.js"></script>
  </head>
  
  <body ng-app="myApp" ng-controller="siteCtrl">
    <h3>
      &nbsp; &nbsp;欢迎回家，{{user.name}}
    </h3>
    <script src="/jquery.min.js"
    >
    </script>
    <script src="/bootstrap.min.js"
    >
    </script>
    <div class="container text-center">
      <span class="label label-default"></span>
      <label class="pull-left">
        场景管理&nbsp; &nbsp;
      </label>
      <div>
        <b><br></b>
        <ul class="list-group">
        </ul>
        <div class="form-group">
        </div>
      </div>
      <div class="form-group">
      </div>
      <div class="form-group">
      </div>
      <div class="form-group">
      </div>
      <ul class="list-group">
      </ul>
      <ul class="list-group">
      </ul>
      <div class="btn-group">
      </div>
      <a href="policinfo.html?uid={{user.uid}}"  type="submit" class="btn pull-right btn-primary btn-xs">
        添加场景
      </a>
      <ul class="list-group">
      </ul>
      <p ng-if="!polic.length" align:center>您还没有场景哦</p>
      <ul class="list-group">
        <li class="list-group-item" ng-repeat="x in polic">
	  <button type="submit" class="btn pull-left btn-xs btn-danger" ng-click="delpolic(x)">
            删除
          </button>

          <a href="policinfo.html?uid={{user.uid}}&mac={{x.mac}}&event={{x.event}}" type="submit" class="btn pull-right btn-xs btn-default">
            编辑
          </a>
          {{x.name}}
        </li>
      </ul>
    </div>
    <hr>
<script>
var app = angular.module('myApp', []);

app.controller('siteCtrl', function($window,$scope, $http, $location) {
        $scope.dolist = new Array();
        console.log($location);
        console.log('hash:'+$location.hash());
        $http({
                method: 'GET',
                url: '/getuserbyuid/' + $location.hash()
        }).then(function successCallback(response) {
                        $scope.user = response.data;
                        console.log(response);
                }, function errorCallback(response) {
                        console.log('get err');
                        // 请求失败执行代码
        });

        var getpolic = function(){
        $http({
                method: 'GET',
                url: '/getpolicbyuser/'+ $location.hash().split('?',1)
        }).then(function successCallback(response) {
                //= JSON.parse(response);
                         $scope.polic = response.data;
                         console.log(response);
                }, function errorCallback(response) {
                        console.log('get err');
                        // 请求失败执行代码
        });
        }

	$scope.delpolic = function(x){
        $http({
                method: 'POST',
                url: '/removepolicbymacevent/',
		data:{"mac":x.mac,"event":x.event}
        }).then(function successCallback(response) {
                //= JSON.parse(response);
                         console.log(response);
                }, function errorCallback(response) {
                        console.log('get err');
                        // 请求失败执行代码
        });
	$window.location.reload();
//	$window.location.href="polic.html#"+$location.hash().split('?',1);
        }


        getpolic();
        $scope.dolist.push({});
        $scope.addaction=function(){
                console.log('dolist:'+$scope.dolist);
                $scope.dolist.push({});
        }
        $scope.adddelay=function(){
                console.log('dolist:'+$scope.dolist);
                var temp = {"type":"delay"}
                $scope.dolist.push(temp);
        }

        $scope.timelist=[
                {'name':'1秒','value':1},
                {'name':'5秒','value':5},
                {'name':'30秒','value':30},
                {'name':'1分','value':60},
                {'name':'5分','value':300}
        ];
        $scope.polic = {
                'mac':'',
                'event':'',
                'do':[]
        };
        $scope.report=function(){
                console.log($scope.dev.mac);
                $scope.polic.mac = $scope.dev.mac;
                $scope.polic.event = $scope.even.value;
                console.log($scope.dolist);
                for(var i=0;i< $scope.dolist.length;i++){
                        var temp={
                                'mac':'',
                                'action':'',
                                'type':'device'
                        };
                        console.log($scope.dolist[i]);
                        if($scope.dolist[i].type != 'delay'){
                                temp.mac=$scope.dolist[i].device.mac;
                        }
                        temp.action=$scope.dolist[i].action.value;
                        if($scope.dolist[i].type == 'delay'){
                                temp.type=$scope.dolist[i].type;
                        }
                        $scope.polic.do.push(temp);
                }
                console.log($scope.polic);
                $http({
                method: 'POST',
                url: '/setpolicbymac/',
                data:$scope.polic
                 }).then(function successCallback(response) {
                        console.log(response);
                        }, function errorCallback(response) {
                        console.log('setdevicebymac return err');
                        // 请求失败执行代码

                });


                $scope.polic = {
                        'mac':'',
                        'event':'',
                        'do':[]
                };
        }

});
</script>


  </body>

</html>
