<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>
    </title>
    <link href="/bootstrap.min.css"
    rel="stylesheet">
    <script src="/angular.min.js"></script>
  </head>

  <body ng-app="myApp" ng-controller="siteCtrl">

    <h3>
      &nbsp; &nbsp;欢迎回家，{{name}}
    </h3>
    <script src="/jquery.min.js"
    >
    </script>
    <script src="/bootstrap.min.js"
    >
    </script>
    <div class="container">
      <span class="label label-default"></span>
      <label>
        场景管理
      </label>
      <div class="row">
        <div class="col-md-3">
	如果
	</div>
        <div class="col-md-3">
		   {{dolist}}+{{dev}}+{{even}}
                    <select required="" class="form-control" ng-model="dev" ng-options="x as x.name for x in device" >  
                    <option value="">设备</option>
		    </select>  
	</div>
      </div>
     	<p>发生
                    <select class="form-control" ng-model="even" ng-options="y as y.name for y in dev.event">  
		    <option value="">事件</option>
                    </select> 
	</p>
	<p></p> 
	<p></p> 
     	<p>那么 <button type="submit"  class="btn btn-default btn-xs" ng-click="addaction()">添加动作</button>&nbsp;<button type="submit"  class="btn btn-info btn-xs" ng-click="adddelay()">添加延时</button>&nbsp;<button type="submit"  class="btn btn-success btn-xs" ng-click="report()">提交</button></p>
	<p ng-repeat="x in dolist">
		{{x.device.mac+x.action.value}}
	    <select required="" ng-if="x.type!='delay'"  class="form-control" ng-model="dolist[$index].device" ng-options="y.name for y in device">
                    <option value="">设备</option>
            </select>
	    <select required="" ng-if="x.type!='delay'" class="form-control" ng-model="dolist[$index].action" ng-options="y.name for y in x.device.do">
                    <option value="">动作</option>
            </select>
	    <select required="" ng-if="x.type=='delay'" class="form-control" ng-model="dolist[$index].action" ng-options="y.name for y in timelist">
                    <option value="">动作</option>
            </select>


	    <button type="submit"  class="btn btn-danger btn-xs" ng-click="dolist.splice($index,1)">删除</button></p>
	</p>
	<div class="form-group">
      </div>
    </div>
<script>
var app = angular.module('myApp', []);

app.controller('siteCtrl', function($scope, $http, $location) {
	$scope.dolist = new Array();
        console.log($location);
        console.log('hash:'+$location.hash());
        $http({
                method: 'GET',
                url: '/getuserbyuid/' + $location.hash()
        }).then(function successCallback(response) {
                        $scope.name = response.data.name;
                        console.log(response);
                }, function errorCallback(response) {
                        console.log('get err');
                        // 请求失败执行代码
        });

	var getdevice = function(){
        $http({
                method: 'GET',
                url: '/getdevicebyuser/'+ $location.hash().split('?',1)
        }).then(function successCallback(response) {
                //= JSON.parse(response);
                         $scope.device = response.data;
                         console.log(response);
                }, function errorCallback(response) {
                        console.log('get err');
                        // 请求失败执行代码
        });
        }
        getdevice();
	$scope.dolist.push({});
	$scope.addaction=function(){
		console.log('dolist:'+$scope.dolist);
		$scope.dolist.push({});
	}
	
	$scope.adddelay=function(){
                console.log('dolist:'+$scope.dolist);
		var temp = {"type":"delay"}
                $scope.dolist.push(temp);
        }

	$scope.timelist=[
		{'name':'1秒','value':1},
		{'name':'5秒','value':5},
		{'name':'30秒','value':30},
		{'name':'1分','value':60},
		{'name':'5分','value':300}
	];
	$scope.polic = {
		'mac':'',
		'event':'',
		'do':[]
	};
	$scope.report=function(){
		console.log($scope.dev.mac);
		$scope.polic.mac = $scope.dev.mac;
		$scope.polic.event = $scope.even.value;
		console.log($scope.dolist);
		for(var i=0;i< $scope.dolist.length;i++){
			var temp={
				'mac':'',
				'action':'',
				'type':'device'	
			};
			console.log($scope.dolist[i]);
			if($scope.dolist[i].type != 'delay'){
				temp.mac=$scope.dolist[i].device.mac;
			}
			temp.action=$scope.dolist[i].action.value;
			if($scope.dolist[i].type == 'delay'){
				temp.type=$scope.dolist[i].type;
			}
			$scope.polic.do.push(temp);
		}
		console.log($scope.polic);
                $http({
                method: 'POST',
                url: '/setpolicbymac/',
                data:$scope.polic
                 }).then(function successCallback(response) {
                        console.log(response);
                        }, function errorCallback(response) {
                        console.log('setdevicebymac return err');
                        // 请求失败执行代码

                });

		console.log('dolist='+JSON.stringify($scope.dolist));
		console.log('polic ='+JSON.stringify($scope.polic));	
		$scope.polic = {
                	'mac':'',
	                'event':'',
        	        'do':[]
	        };
	}

});
</script>

  </body>

</html>
